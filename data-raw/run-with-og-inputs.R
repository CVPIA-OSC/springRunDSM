library(tidyverse)
source('data-raw/load-old-inputs.R')

sim <- spring_run_model(seeds = old_seeds, stochastic = FALSE,
                        mode = "simulate", ..params = params)

v1.1 <- sim$spawners
v1.0 <- structure(c(42.6547296715519, 86.3523437645127, 409.330245159721, 
                    0, 46.9802075161597, 11452.4842294936, 778.292843432228, 43.1669573110449, 
                    0, 545.041695460445, 0, 690.378659594213, 0, 0, 42.6547296715519, 
                    0, 0, 0, 6008.09410645565, 842.606719511107, 0, 0, 0, 0, 42.758329977504, 
                    42.758329977504, 42.758329977504, 42.7620791406662, 42.7620791406662, 
                    42.7620791406662, 0, 39.5235925127827, 80.038743217496, 337.913779999419, 
                    0, 43.8490703573905, 10430.9556616253, 721.786682978289, 40.0358201522757, 
                    0, 440.73642655597, 0, 611.279806906162, 0, 0, 39.5235925127827, 
                    0, 0, 0, 6440.84277336403, 833.36779942875, 0, 0, 0, 0, 39.6195878762085, 
                    39.6195878762085, 39.6195878762085, 39.6230618261838, 39.6230618261838, 
                    39.6230618261838, 0, 31.8870317214397, 65.9630154054699, 320.525487870728, 
                    0, 36.2157981452009, 8669.37141410163, 520.006332861058, 32.4196960882731, 
                    0, 379.864300146514, 0, 477.084829855399, 0, 0, 31.866865704776, 
                    0, 0, 0, 5631.2326358991, 806.506501462609, 0, 0, 0, 0, 31.9412854248349, 
                    31.9412854248349, 31.9412854294156, 31.9440861209971, 31.9441885417298, 
                    31.9442950299827, 0, 29.9170377952522, 65.5515240974077, 386.02220486783, 
                    0, 34.2594628371876, 8163.35826622156, 427.624858992458, 30.6543137861868, 
                    0, 392.450241731014, 0, 650.341533418557, 0, 0, 29.8676182967613, 
                    0, 0, 0, 5140.22428774868, 795.868286100947, 0, 0, 0, 0, 29.9229133535517, 
                    29.9229133535517, 29.9229157109367, 29.9255370735266, 29.9258028197308, 
                    29.9261011351152, 0, 38.1316802936261, 84.3094645455581, 466.107126924016, 
                    0, 42.4924730936588, 10072.2958620073, 628.769230083773, 39.024474042703, 
                    0, 463.855696599908, 0, 875.472639301882, 0, 0, 38.0697870366243, 
                    0, 0, 0, 5503.65619294469, 831.924525021198, 0, 0, 0, 0, 38.1333934429993, 
                    38.1333934429993, 38.1334032938161, 38.1367370795264, 38.1387826595804, 
                    38.1386852729651, 0, 44.5025019675442, 95.9239496907532, 402.570573596609, 
                    0, 48.8539968783336, 11684.1707334782, 771.256550751753, 45.2745253539416, 
                    0, 421.455136297142, 0, 803.131482261089, 0, 0, 44.4336887691435, 
                    0, 0, 0, 6431.80097403804, 856.0892072556, 0, 0, 0, 0, 44.5183278801985, 
                    44.5183278801985, 44.5183425350942, 44.5222313646195, 44.5273644611406, 
                    44.5261245696681, 0, 44.146051341225, 94.5842338922826, 329.591289970658, 
                    0, 48.4741689475921, 11097.9988077342, 715.001036483759, 44.8341400535065, 
                    0, 364.621568163889, 0, 741.964388874101, 0, 0, 44.0945553082221, 
                    0, 0, 0, 6927.27246138316, 853.864684246029, 0, 0, 0, 0, 44.1868556158618, 
                    44.1868556158618, 44.1868673389244, 44.1907300359202, 44.1958197550199, 
                    44.193969829866, 0, 35.0092800182692, 77.3334128898334, 298.138885595686, 
                    0, 39.3582932444062, 9774.78723364749, 597.83800002048, 35.6043259788911, 
                    0, 337.678545620837, 0, 584.007126349194, 0, 0, 34.9640381179653, 
                    0, 0, 0, 5886.87644009134, 862.733544114637, 0, 0, 0, 0, 35.0371294261965, 
                    35.0371294261965, 35.0371598276703, 35.0402015741271, 35.0430408175729, 
                    35.0413988269612, 0, 32.3904976371846, 72.6117172405864, 285.261744830994, 
                    0, 36.7701652143364, 8984.76706508903, 546.999821348884, 32.942961477081, 
                    0, 303.673473887763, 0, 522.804160773152, 0, 0, 32.3282855680239, 
                    0, 0, 0, 5031.07917879196, 893.777346954822, 0, 0, 0, 0, 32.3946800232705, 
                    32.3946800232705, 32.3947291408443, 32.397520474267, 32.4005208895144, 
                    32.3983191530178, 0, 31.8099408803782, 70.7161961579208, 299.925792783859, 
                    0, 36.169301933541, 8741.37438416675, 531.385050012172, 32.4965023635807, 
                    0, 261.559135479803, 0, 599.038871291723, 0, 0, 31.764166291692, 
                    0, 0, 0, 5013.09620564798, 868.143591520172, 0, 0, 0, 0, 31.8316332624809, 
                    31.8316332624809, 31.8316565512095, 31.8344243440523, 31.8387212034599, 
                    31.835376588128, 0, 29.6250493394868, 65.5352376527761, 288.545354015434, 
                    0, 33.9577545214272, 8619.50182564884, 496.182585950782, 30.32852280228, 
                    0, 233.382202604754, 0, 500.567171400943, 0, 0, 29.5994571043298, 
                    0, 0, 0, 4990.39976199215, 805.89700681845, 0, 0, 0, 0, 29.6653716122208, 
                    29.6653716122208, 29.6653716191223, 29.6679727502564, 29.6721172050687, 
                    29.6684507955015, 0, 28.2698404899983, 62.7102334052361, 263.125938940494, 
                    0, 32.6010984402771, 7946.08688844285, 476.035897870122, 28.9391947551428, 
                    0, 225.251193224056, 0, 429.015593924436, 0, 0, 28.2464947151294, 
                    0, 0, 0, 4982.15485030826, 776.077111422071, 0, 0, 0, 0, 28.3103104203885, 
                    28.3103104203885, 28.3103104209962, 28.3127927430843, 28.3164806334166, 
                    28.3129045842286, 0, 28.23305297572, 62.23364976002, 277.90223726364, 
                    0, 32.5630354209101, 7902.84504220499, 450.575744815861, 28.9258472641274, 
                    0, 205.500376885759, 0, 476.22091538791, 0, 0, 28.2078551824537, 
                    0, 0, 0, 4977.24633649178, 803.142473322688, 0, 0, 0, 0, 28.2721751614739, 
                    28.2721751614739, 28.2721751617428, 28.2746541403697, 28.2798179984113, 
                    28.2748427804908, 0, 33.2068504891259, 71.9133590217318, 300.029623425999, 
                    0, 37.5482429337599, 9891.55074244604, 432.560462407452, 33.8064402105509, 
                    0, 203.449092015782, 0, 388.360663842375, 0, 0, 33.1824266696187, 
                    0, 0, 0, 4985.03155735933, 852.427232178044, 0, 0, 0, 0, 33.2585687040042, 
                    33.2585687040042, 33.2585687042294, 33.2614849030391, 33.267356787258, 
                    33.2617979560374, 0, 37.1807139046197, 80.0640866337793, 323.507136628267, 
                    0, 41.5371861180857, 11230.7718907178, 428.605861841353, 37.6825431179092, 
                    0, 218.227743466614, 0, 311.751745168462, 0, 0, 37.1492837035818, 
                    0, 0, 0, 5002.81001760441, 925.566290021218, 0, 0, 0, 0, 37.233661104378, 
                    37.233661104378, 37.2336611057296, 37.2369258500002, 37.2396240045431, 
                    37.2372011928934, 0, 33.6552504199256, 73.3485064091848, 341.891744568811, 
                    0, 37.9993330878785, 9813.69740925217, 396.057922515455, 34.1418395248075, 
                    0, 213.92996451603, 0, 317.897292482266, 0, 0, 33.6075792114938, 
                    0, 0, 0, 5007.74963344525, 1018.39431383197, 0, 0, 0, 0, 33.682908266494, 
                    33.682908266494, 33.6829084278509, 33.6858616727411, 33.6863215316292, 
                    33.6860477371593, 0, 29.3479110967424, 65.1536056926557, 312.430874672586, 
                    0, 33.6708970594396, 8550.22242426311, 357.99197593109, 29.8259681517498, 
                    0, 202.216380145835, 0, 252.447876710979, 0, 0, 29.2790339091092, 
                    0, 0, 0, 5027.9288622625, 988.90367469854, 0, 0, 0, 0, 29.3437880000707, 
                    29.3437880000707, 29.3437915252811, 29.3463609408069, 29.3469888910876, 
                    29.3465656712648, 0, 32.4460102150267, 71.3104209210236, 322.800075198847, 
                    0, 36.7628325659775, 9361.28377384076, 414.561244825187, 32.9855553085076, 
                    0, 206.958120264675, 0, 280.698472627974, 0, 0, 32.3429565900994, 
                    0, 0, 0, 5118.64452907885, 1054.491803448, 0, 0, 0, 0, 32.4106562543534, 
                    32.4106562543534, 32.4106649499463, 32.4134981061881, 32.413904185092, 
                    32.4138041402741, 0, 33.7270698201146, 73.4758618826028, 326.698456199421, 
                    0, 38.038406134133, 9019.03993751773, 495.649733388836, 34.3190192836142, 
                    0, 210.439983710358, 0, 320.340180512575, 0, 0, 33.6144681213898, 
                    0, 0, 0, 5405.90319480781, 1701.51053103073, 0, 0, 0, 0, 33.6829862398583, 
                    33.6829862398583, 33.6829997390877, 33.6859396529423, 33.6870484808992, 
                    33.6873568688341, 0, 27.5098252390387, 60.89421236441, 247.38002431377, 
                    0, 31.8165457599884, 6610.02818270993, 506.799820452068, 28.0189096312257, 
                    0, 203.369157006029, 0, 232.51486885617, 0, 0, 27.3980797882599, 
                    0, 0, 0, 5597.46355440878, 2151.88743520324, 0, 0, 0, 0, 27.4536528273247, 
                    27.4536528273247, 27.4537314159327, 27.4560600360231, 27.4582550819707, 
                    27.4589162879652, 0), .Dim = c(31L, 20L))

# cbind(v1.1, v1.0, (v1.1-v1.0)/v1.0)
# summary((v1.1-v1.0)/v1.0)

all_data <- bind_rows(
  as_tibble(v1.1) %>% 
    mutate(watershed = DSMscenario::watershed_labels) %>% 
    gather(year, spawners, -watershed) %>% 
    mutate(year = as.numeric(year), version = '1.1'),
  as_tibble(v1.0) %>% 
    mutate(watershed = DSMscenario::watershed_labels) %>% 
    gather(year, spawners, -watershed) %>% 
    mutate(year = parse_number(year), version = '1.0')
)

all_data %>% 
  ggplot(aes(year, spawners, color = version)) +
  geom_line() +
  facet_wrap(~watershed, scales = "free_y")

tibble(year = 1:20,
       v1.1, v1.0) %>% 
  gather(scenario, spawners, - year) %>% 
  ggplot(aes(year, spawners, color = scenario)) +
  geom_line() +
  scale_x_continuous(breaks = 1:20) +
  ylim(c(0,9000))

(mean(v1.1) - mean(v1.0))/mean(v1.0)
